<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>New Request Form</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body, button, input, select, textarea {
      font-family: 'Poppins', sans-serif;
    }
    .priority-btn-group {
      display: flex;
      justify-content: space-between;
      width: 100%;
    }

    .priority-btn-group .btn {
      flex: 1;
      display: flex;
      align-items: center;   /* centers text vertically */
      justify-content: center; /* centers text horizontally */
      text-align: center;
    }

    .priority-btn-group .btn {
      min-width: 60px;
    }
    .priority-btn-group .btn.active {
      background-color: #2C6C93;
      color: white;
 }
    /* === Added for feature vote table === */
    .feature-table th, .feature-table td { text-align: center; vertical-align: middle; }
    .feature-table th:first-child, .feature-table td:first-child { text-align: left; width: 48%; }
    .feature-table th:nth-child(2), .feature-table td:nth-child(2) { width: 16%; }
    .feature-table th:nth-child(3), .feature-table th:nth-child(4), .feature-table th:nth-child(5) { width: 12%; }
    .vote-count { display: none !important; }


    /* === Suggestion dropdown styling === */
    .suggestion-box {
      z-index: 1000;
      max-height: 220px;   /* taller so 4 items fit nicely */
      overflow-y: auto;
      border: 1px solid #2C6C93;
      border-radius: 0.25rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .suggestion-box .list-group-item {
      background-color: #ffffff;
      color: #2C6C93;
      cursor: pointer;
      padding: 0.5rem 1rem;
      border: none;
    }

    .suggestion-box .list-group-item:hover,
    .suggestion-box .list-group-item:focus {
      background-color: #2C6C93;
      color: #ffffff;
    }

  </style>
</head>
<body class="bg-light">

<!-- Disclaimer Modal -->
<div class="modal fade" id="disclaimerModal" tabindex="-1" aria-labelledby="disclaimerLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      
      <div class="modal-header">
        <h5 class="modal-title" id="disclaimerLabel">Disclaimer</h5>
      </div>

      <div class="modal-body">
        <p>
          Please note that submitting this form is not a promise of delivery or implementation. 
          These are requests only. We will review every suggestion but cannot promise any feature or timeline.
        </p>

        <p class="fw-semibold mt-3">Please choose where you would like to go:</p>

        <div class="row g-2">
          <div class="col-6">
            <input type="radio" class="btn-check" name="disclaimerChoice" id="featureRequest" value="Feature Request" autocomplete="off" required>
            <label class="btn btn-outline-primary w-100 text-center" for="featureRequest">Feature Request</label>
          </div>
          <div class="col-6">
            <input type="radio" class="btn-check" name="disclaimerChoice" id="roadmap" value="Roadmap" autocomplete="off" required>
            <label class="btn btn-outline-primary w-100 text-center" for="roadmap">Roadmap</label>
          </div>
        </div>
      </div> <!-- end modal-body -->

      <div class="modal-footer d-flex justify-content-end">
        <button id="agreeBtn" type="button" class="btn btn-primary" disabled>I Agree</button>
      </div>

    </div>
  </div>
</div>


<!-- Step 1 -->
<div class="step" id="step1">
  <div class="container p-4" id="formContainer" style="display: none;">
    <img src="Logo-dark.png" alt="Logo" class="d-block mx-auto mb-3" style="max-width: 200px;" />
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0" style="font-weight: 600; color: #2C6C93;">New Request Form</h4>
  <button type="button" class="btn btn-secondary btn-sm" onclick="nextStep()"  style="background-color:#62A6D0; color:white; border:none;">In Progress / Planned Features</button>
</div>

<form id="requestForm" enctype="multipart/form-data" method="POST" action="https://3156ce6ad598.ngrok-free.app/submit">
  <!-- Dealer Info -->
  <div class="mb-3">
    <label class="form-label">Requestor Name <span class="text-danger">*</span></label>
    <input type="text" class="form-control" name="requestor_name" id="requestor_name_step1" required />
  </div>
  <div class="mb-3">
    <label class="form-label">Dealer's Name <span class="text-danger">*</span></label>
    <input type="text" class="form-control" name="dealer_name" id="dealer_name_step1" required />
  </div>
  <div class="mb-3">
    <label class="form-label">Email <span class="text-danger">*</span></label>
    <input type="email" class="form-control" name="email" id="email_step1" required />
  </div>
  <div class="mb-3">
    <label class="form-label">Phone Number (Optional)</label>
    <input type="tel" class="form-control" name="phone" />
  </div>

  <!-- Features -->
  <div id="featureBlocks">
    <!-- Feature block will be added dynamically by JS -->
  </div>

  <button type="button" id="addFeature" class="btn btn-outline-secondary mb-3">+ Add Another Feature</button>
  <button type="submit" class="btn w-100" style="background-color: #2C6C93; color: white; border: none;">Submit</button>
</form>
  <footer class="text-center mt-5 text-muted" style="font-size: 0.9rem;">
    Created by Cristhoper Ambuludi &amp; Daniel Shifrin
  </footer>
  </div>
</div>


<!-- Step 2 -->
<div class="step" id="step2" style="display: none;">
  <div class="container p-4">
    <img src="Logo-dark.png" alt="Logo" class="d-block mx-auto mb-3" style="max-width: 200px;" />

    <!-- Top-left Back Button -->
    <div class="d-flex justify-content-start mb-3">
      <button type="button" class="btn btn-outline-secondary" onclick="prevStep()">← Back</button>
    </div>

    <h4 class="mb-3" style="color: #2C6C93;">Requests in Development</h4>

    <div class="mb-3">
      <label class="form-label">Requestor Name <span class="text-danger">*</span></label>
      <input type="text" class="form-control mirror-input" name="requestor_name" id="requestor_name_step2" required />
    </div>
    <div class="mb-3">
      <label class="form-label">Dealer's Name <span class="text-danger">*</span></label>
      <input type="text" class="form-control mirror-input" name="dealer_name" id="dealer_name_step2" required />
    </div>
    <div class="mb-3">
      <label class="form-label">Email <span class="text-danger">*</span></label>
      <input type="email" class="form-control mirror-input" name="email" id="email_step2" required />
    </div>

    <!-- Search -->
    <div class="input-group mb-3">
      <input type="text" id="searchInput" class="form-control" placeholder="Search features or keywords..." oninput="filterMasterList()" />
    </div>

    <div id="masterListContainer">Loading list...</div>

    <!-- Bottom-left Back Button / Submit -->
    <div class="d-flex mt-4">
      <button type="button" class="btn btn-outline-secondary me-auto" onclick="prevStep()">← Back</button>
      <button type="button" id="submitVotes" class="btn btn-primary">Submit</button>
    </div>
  <footer class="text-center mt-5 text-muted" style="font-size: 0.9rem;">
    Created by Cristhoper Ambuludi &amp; Daniel Shifrin
  </footer>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const disclaimerModal = new bootstrap.Modal(document.getElementById('disclaimerModal'));
  disclaimerModal.show();
  loadMasterList();

  // ✅ Enable "I Agree" only if a choice is made
  document.querySelectorAll('input[name="disclaimerChoice"]').forEach(radio => {
    radio.addEventListener('change', () => {
      document.getElementById('agreeBtn').disabled = false;
    });
  });

  document.getElementById('agreeBtn').addEventListener('click', () => {
    const choice = document.querySelector('input[name="disclaimerChoice"]:checked').value;

    disclaimerModal.hide();

    if (choice === "Feature Request") {
      // Show Step 1 (form)
      document.getElementById('formContainer').style.display = 'block';
      addFeatureBlock();
    } else if (choice === "Roadmap") {
      // Jump to Step 2 (Requests in Development)
      if (steps.length === 0) steps = Array.from(document.querySelectorAll('.step'));
      currentStep = 1; // step2 index
      steps.forEach((s, i) => s.style.display = (i === 1 ? 'block' : 'none'));
      loadMasterList();
    }
  });


  const container = document.getElementById('featureBlocks');
  let featureCount = 0;
  const maxFeatures = 3;

  document.getElementById('addFeature').addEventListener('click', () => {
    if (featureCount < maxFeatures) addFeatureBlock();
  });

  function addFeatureBlock() {
    featureCount++;
    const block = document.createElement('div');
    block.className = 'feature-block mb-4';
    block.dataset.index = featureCount;
    block.innerHTML = `
      <h5 class="mt-4 mb-3">Feature ${featureCount}</h5>
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-8 position-relative">
          <label class="form-label">Feature Name <span class="text-danger">*</span></label>
          <input type="text" 
                 class="form-control feature-name-input" 
                 name="feature_name_${featureCount}" 
                 id="feature_name_${featureCount}" 
                 autocomplete="off" required>
          <!-- Suggestion dropdown -->
          <div class="list-group position-absolute w-100 d-none suggestion-box" 
               id="suggestions_${featureCount}"></div>

        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Feature Priority <span class="text-danger">*</span></label>
          <div class="btn-group w-100 priority-btn-group" role="group" data-feature="${featureCount}">
            <input type="hidden" name="priority_${featureCount}" required>
            <button type="button" class="btn btn-outline-secondary" data-value="1">Urgent</button>
            <button type="button" class="btn btn-outline-secondary" data-value="2">Normal</button>
            <button type="button" class="btn btn-outline-secondary" data-value="3">Optional</button>
          </div>
        </div>
      </div>
      <div class="col-12 position-relative">
        <label class="form-label mt-3">Please describe the feature you are requesting and how it would improve your business. <span class="text-danger">*</span></label>
        <textarea class="form-control feature-description-input" 
                  name="feature_description_${featureCount}" 
                  id="feature_description_${featureCount}" 
                  rows="4" required></textarea>

        <!-- Suggestion dropdown for description -->
        <div class="list-group position-absolute w-100 d-none suggestion-box" 
             id="desc_suggestions_${featureCount}"></div>

      </div>

      <label class="form-label mt-3">Do you have any examples, screenshots, or mockups to share? (optional)</label>
      <input type="file" class="form-control" name="attachment_${featureCount}" accept="image/*,.pdf,.doc,.docx" />
      <label class="form-label mt-3">Severity <span class="text-danger">*</span></label>
      <select class="form-select severity-select" name="severity_${featureCount}" required>
        <option value="">-- Select Severity --</option>
        <option value="1">1 - Nice to Have</option>
        <option value="2">2 - Important but Workable</option>
        <option value="3">3 - Cannot Operate/Sell without</option>
      </select>
    `;
    container.appendChild(block);
    attachAutocompleteToNewBlock(featureCount);
    updatePriorityButtons();
    updateSeverityDropdowns();
    if (featureCount >= maxFeatures) document.getElementById('addFeature').disabled = true;
  }

  function updatePriorityButtons() {
    const allButtons = document.querySelectorAll('.priority-btn-group .btn');
    const selectedValues = Array.from(document.querySelectorAll('.priority-btn-group input')).map(i => i.value).filter(v => v);

    allButtons.forEach(btn => {
      const btnVal = btn.dataset.value;
      const parentGroup = btn.closest('.priority-btn-group');
      const currentInput = parentGroup.querySelector('input');
      const isSelectedElsewhere = selectedValues.includes(btnVal) && currentInput.value !== btnVal;
      btn.disabled = isSelectedElsewhere;
    });
  }

  function updateSeverityDropdowns() {
    const selects = document.querySelectorAll('.severity-select');
    const selected = Array.from(selects).map(s => s.value).filter(v => v);

    selects.forEach(select => {
      const currentValue = select.value;
      const options = select.querySelectorAll('option');

      options.forEach(option => {
        const val = option.value;
        option.disabled = val && selected.includes(val) && val !== currentValue;
      });
    });
  }

  // ✅ Added to handle severity dropdown updates on change
  document.addEventListener('change', e => {
    if (e.target.matches('.severity-select')) {
      updateSeverityDropdowns();
    }
  });

  document.addEventListener('click', e => {
    if (e.target.matches('.priority-btn-group .btn')) {
      const group = e.target.closest('.priority-btn-group');
      const hiddenInput = group.querySelector('input');
      hiddenInput.value = e.target.dataset.value;
      group.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
      e.target.classList.add('active');
      updatePriorityButtons();
    }
  });

  document.getElementById('requestForm').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    try {
      const response = await fetch(form.getAttribute('action'), {
        method: 'POST',
        body: formData
      });
      if (response.ok) {
        alert('Form submitted successfully!');
        form.reset();
        container.innerHTML = '';
        featureCount = 0;
        addFeatureBlock();
        document.getElementById('addFeature').disabled = false;
      } else {
        const err = await response.json();
        alert('Submission failed: ' + (err.message || response.statusText));
      }
    } catch (error) {
      alert('Network error: ' + error.message);
    }
  });
//  Place your nextStep function here
let currentStep = 0;
let steps = [];
function nextStep() {
    if (steps.length === 0) steps = Array.from(document.querySelectorAll('.step'));

  if (currentStep < steps.length - 1) {
    steps[currentStep].style.display = 'none';
    currentStep++;
    steps[currentStep].style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });

    //  Correctly placed here
    if (currentStep === 1) loadMasterList();
  }
}
function prevStep() {
  if (steps.length === 0) steps = Array.from(document.querySelectorAll('.step'));

  if (currentStep > 0) {
    steps[currentStep].style.display = 'none';
    currentStep--;
    steps[currentStep].style.display = 'block';

    // ✅ Make sure Step 1 shows the form again
    if (currentStep === 0) {
      const formContainer = document.getElementById('formContainer');
      formContainer.style.display = 'block';

      // If no feature block exists yet, add one
      if (document.querySelectorAll('.feature-block').length === 0) {
        addFeatureBlock();
      }
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}


let masterData = []; // Global array for filtering

async function loadMasterList() {
  const container = document.getElementById('masterListContainer');
  try {
    const res = await fetch('https://raw.githubusercontent.com/pecanaiteam/new-requests-form/main/master_list2.json');
    const dataObj = await res.json();

    const data = Array.isArray(dataObj) ? dataObj : dataObj["Feature Timeline Confidential 1"];
    if (!Array.isArray(data)) throw new Error("Expected an array");

    masterData = data; // Save globally
    const features = augmentVotes({ "Feature Timeline Confidential 1": masterData });
    renderMasterListRadios(features);

  } catch (err) {
    console.error("Error loading master list:", err);
    container.innerHTML = `<div class="alert alert-danger">Failed to load master list.</div>`;
  }
}
function renderMasterList(data) {
  const container = document.getElementById('masterListContainer');

  const html = `
    <table class="table table-bordered">
      <thead style="background-color: #2C6C93; color: white;">
        <tr>
          <th>Feature</th>
          <th>Status (Due Date)</th>
        </tr>
      </thead>
      <tbody>
        ${data.map((row, i) => `
          <tr style="${i % 2 === 1 ? 'background-color: #f8f9fa;' : 'background-color: #e8eff7;'}">
            <td>${row["Summary"] || ""}</td>
            <td>${row["Inferred due date"] || ""}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  container.innerHTML = html;
}
function filterMasterList() {
  const query = document.getElementById('searchInput').value.trim().toLowerCase();


  const filtered = masterData.filter(row => {
    const summary = row["Summary"] || "";
    const paraphrases = Object.keys(row)
      .filter(k => k.toLowerCase().startsWith("paraphrase"))
      .map(k => row[k] || "");

    const allText = [summary, ...paraphrases].join(" ").toLowerCase();
    return allText.includes(query);
  });

  const features = augmentVotes({ "Feature Timeline Confidential 1": filtered });
  renderMasterListRadios(features);

}

// ===== Backend (optional) =====
const BACKEND_URL = "https://3156ce6ad598.ngrok-free.app/feature-vote"; // e.g. "https://api.yoursite.com/feature-vote"

// ===== Data normalizer (works with your nested JSON) =====
function augmentVotes(rootObj) {
  const arr = Array.isArray(rootObj) ? rootObj : (rootObj?.["Feature Timeline Confidential 1"] || []);
  return arr.map((row, i) => {
    const summary = row["Summary"] ?? `Feature ${i+1}`;
    const id = row.id || `feat_${slugify(summary)}`.slice(0, 64);
    return {
      ...row,
      id,
      votes_no:   toInt(row.votes_no),
      votes_nice: toInt(row.votes_nice),
      votes_must: toInt(row.votes_must)
    };
  });
}

// ===== New renderer: 3 aligned radio columns + counters =====
function renderMasterListRadios(dataArray) {
  const el = document.getElementById('masterListContainer');
  if (!el) return;

  const header = `
    <table class="table table-bordered table-sm feature-table">
      <thead style="background-color:#2C6C93;color:white;">
        <tr>
          <th>Feature</th>
          <th>Status (Due Date)</th>
          <th>No interest</th>
          <th>I’ll be nice</th>
          <th>Must have</th>
        </tr>
      </thead>
      <tbody>
  `;

  const rows = dataArray.map((row, i) => {
    const summary = row["Summary"] ?? "";
    const due     = row["Inferred due date"] ?? "—";
    const id      = row.id;
    const name    = `pref_${id}`;

    const checked = { no: "", nice: "", must: "" }; // never pre-check


    const alt = (i % 2 === 1) ? ' style="background:#f8f9fa;"' : '';
    const c_no   = toInt(row.votes_no);
    const c_nice = toInt(row.votes_nice);
    const c_must = toInt(row.votes_must);

    return `
      <tr${alt} data-feature-id="${escapeHtml(id)}">
        <td class="align-middle">${escapeHtml(summary)}</td>
        <td class="align-middle">${escapeHtml(due)}</td>

        <td class="align-middle">
          <input class="pref-dot" type="radio" name="${escapeHtml(name)}" value="no" ${checked.no}
                 aria-label="No interest for ${escapeHtml(summary)}">
          <span class="vote-count" id="cnt_${id}_no">${c_no}</span>
        </td>

        <td class="align-middle">
          <input class="pref-dot" type="radio" name="${escapeHtml(name)}" value="nice" ${checked.nice}
                 aria-label="I'll be nice for ${escapeHtml(summary)}">
          <span class="vote-count" id="cnt_${id}_nice">${c_nice}</span>
        </td>

        <td class="align-middle">
          <input class="pref-dot" type="radio" name="${escapeHtml(name)}" value="must" ${checked.must}
                 aria-label="Must have for ${escapeHtml(summary)}">
          <span class="vote-count" id="cnt_${id}_must">${c_must}</span>
        </td>
      </tr>
    `;
  }).join('');

  el.innerHTML = header + rows + `</tbody></table>`;
// make sure nothing is pre-selected and disable browser autofill
  el.querySelectorAll('input.pref-dot').forEach(r => {
  r.checked = false;
  r.autocomplete = 'off';
});
}

// ===== Collect selected radios from the table =====
function collectVotes() {
  const rows = Array.from(document.querySelectorAll('#masterListContainer tbody tr[data-feature-id]'));
  const votes = [];
  rows.forEach(row => {
    const id = row.getAttribute('data-feature-id');
    const checked = row.querySelector('input.pref-dot:checked');
    if (id && checked) {
      votes.push({ id, choice: checked.value }); // choice is "no" | "nice" | "must"
    }
  });
  return votes;
}

// ===== Submit all selections in one request =====
const submitBtn = document.getElementById('submitVotes');
if (submitBtn) {
  submitBtn.addEventListener('click', async () => {
    const votes = collectVotes(); // can be empty (allowed)
    // Optional: confirm if nothing is selected
    // if (votes.length === 0) {
    //   if (!confirm('No selections were made. Submit anyway?')) return;
    // }

    if (!BACKEND_URL) {
      alert('Thanks! Your selections were recorded locally.\n(Backend URL is not configured, so nothing was submitted to the server.)');
      return;
    }

    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    try {
      const res = await fetch(BACKEND_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        // You can add extra metadata here if needed (e.g., user, timestamp)
        body: JSON.stringify({ votes }) 
      });

      if (!res.ok) {
        const msg = await res.text().catch(()=>'');
        throw new Error(msg || `HTTP ${res.status}`);
      }

      // Optional: clear localStorage so the next person starts fresh on this device
      // localStorage.clear();

      alert('Thanks! Your selections were submitted.');
    } catch (err) {
      console.warn('Submit failed:', err);
      alert('Submission failed. Please try again.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });
}


// ===== Helpers =====
function adjustCount(id, which, delta) {
  const el = document.getElementById(`cnt_${id}_${which}`);
  if (!el) return;
  const n = toInt(el.textContent) + delta;
  el.textContent = Math.max(0, n);
}
function setCounts(id, cNo, cNice, cMust) {
  const map = { no: cNo, nice: cNice, must: cMust };
  Object.entries(map).forEach(([k,v]) => {
    const el = document.getElementById(`cnt_${id}_${k}`);
    if (el) el.textContent = toInt(v);
  });
}
function toInt(v) { return Number.parseInt(v ?? 0, 10) || 0; }
function escapeHtml(str) {
  return String(str)
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}
function slugify(s) {
  return String(s).toLowerCase()
    .replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')
    .slice(0, 60) || 'item';
}

// Keep Step 1 and Step 2 inputs mirrored
// Mirror values between Step 1 and Step 2
function setupMirroredInputs() {
  const pairs = [
    ["requestor_name_step1", "requestor_name_step2"],
    ["dealer_name_step1", "dealer_name_step2"],
    ["email_step1", "email_step2"]
  ];

  pairs.forEach(([id1, id2]) => {
    const input1 = document.getElementById(id1);
    const input2 = document.getElementById(id2);

    if (input1 && input2) {
      // When Step 1 changes, update Step 2
      input1.addEventListener("input", () => {
        input2.value = input1.value;
      });

      // When Step 2 changes, update Step 1
      input2.addEventListener("input", () => {
        input1.value = input2.value;
      });
    }
  });
}

document.addEventListener("DOMContentLoaded", setupMirroredInputs);

// === Autocomplete setup ===

// Autocomplete handler for one field
function setupAutocomplete(inputEl, suggestionBox) {
  inputEl.addEventListener("input", () => {
    const query = inputEl.value.trim().toLowerCase();
    if (!query || masterData.length === 0) {
      suggestionBox.classList.add("d-none");
      return;
    }

    // Get top 4 matches
    const matches = masterData
      .filter(row => (row["Summary"] || "").toLowerCase().includes(query))
      .slice(0, 4);

    if (matches.length === 0) {
      suggestionBox.classList.add("d-none");
      return;
    }

    // Build suggestion list
    suggestionBox.innerHTML = matches
      .map(m => `<button type="button" class="list-group-item list-group-item-action">${m["Summary"]}</button>`)
      .join("");

    suggestionBox.classList.remove("d-none");

    // When a suggestion is clicked
    suggestionBox.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        inputEl.value = btn.textContent;
        suggestionBox.classList.add("d-none");
      });
    });
  });

  // Hide suggestions on blur (after short delay so click works)
  inputEl.addEventListener("blur", () => {
    setTimeout(() => suggestionBox.classList.add("d-none"), 200);
  });
}

// Attach autocomplete when a new feature block is added
function attachAutocompleteToNewBlock(index) {
  const inputEl = document.getElementById(`feature_name_${index}`);
  const suggestionBox = document.getElementById(`suggestions_${index}`);
  if (inputEl && suggestionBox) {
    setupAutocomplete(inputEl, suggestionBox);
  }
}

// === Autocomplete for description field ===
function setupDescriptionAutocomplete(textareaEl, suggestionBox, featureInput) {
  textareaEl.addEventListener("input", () => {
    const query = textareaEl.value.trim().toLowerCase();
    if (!query || masterData.length === 0) {
      suggestionBox.classList.add("d-none");
      return;
    }

    const queryWords = query.split(/\s+/).filter(w => w.length > 2);

    const matches = masterData
      .map(row => {
        const combined = [
          row["Summary"] || "",
          ...Object.keys(row)
              .filter(k => k.toLowerCase().startsWith("paraphrase"))
              .map(k => row[k] || "")
        ].join(" ").toLowerCase();

        let score = 0;
        queryWords.forEach(word => {
          if (combined.includes(word)) score++;
        });

        return { row, score };
      })
      .filter(m => m.score > 0)
      .sort((a, b) => b.score - a.score);

    // keep only top 4, drop weak matches
    const best = matches.length > 0 ? matches[0].score : 0;
    const filtered = matches.filter(m => m.score >= Math.max(1, best * 0.4)).slice(0, 4);

    if (filtered.length === 0) {
      suggestionBox.classList.add("d-none");
      return;
    }

    suggestionBox.innerHTML = filtered
      .map(m => `<button type="button" class="list-group-item list-group-item-action">${m.row["Summary"]}</button>`)
      .join("");

    suggestionBox.classList.remove("d-none");

    suggestionBox.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        // ✅ Fill Feature Name, keep description untouched
        featureInput.value = btn.textContent;
        suggestionBox.classList.add("d-none");
      });
    });
  });

  textareaEl.addEventListener("blur", () => {
    setTimeout(() => suggestionBox.classList.add("d-none"), 200);
  });
}

// Extend autocomplete hookup for new blocks
function attachAutocompleteToNewBlock(index) {
  const inputEl = document.getElementById(`feature_name_${index}`);
  const suggestionBox = document.getElementById(`suggestions_${index}`);
  if (inputEl && suggestionBox) {
    setupAutocomplete(inputEl, suggestionBox);
  }

  const descEl = document.getElementById(`feature_description_${index}`);
  const descBox = document.getElementById(`desc_suggestions_${index}`);
  if (descEl && descBox && inputEl) {
    setupDescriptionAutocomplete(descEl, descBox, inputEl);
  }
}



</script>
</body>
</html>
